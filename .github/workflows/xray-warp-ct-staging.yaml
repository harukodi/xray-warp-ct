name: xray-warp-ct staging CI/CD

on: workflow_dispatch

jobs:
  build-staging-image:
    uses: ./.github/workflows/build-staging.yaml
    with:
      DOCKERHUB_USERNAME: xia1997x
      DOCKERHUB_REGISTRY: xray-warp-staging
    secrets:
      DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}

  reset-staging-environment:
    uses: ./.github/workflows/destroy-environment-staging.yaml
    with:
      CONFIG_DIRECTORY: tests/infrastructure
    secrets:
      TF_API_TOKEN: ${{ secrets.TF_API_TOKEN }}
    needs: [build-staging-image]

  setup-staging-environment:
    uses: ./.github/workflows/setup-environment-staging.yaml
    with:
      CONFIG_DIRECTORY: tests/infrastructure
    secrets:
      TF_API_TOKEN: ${{ secrets.TF_API_TOKEN }}
    needs: [build-staging-image, destroy-staging-environment]

  check-xray-warp-ct-server-connectivity:
    uses: ./.github/workflows/xray-warp-ct-connectivity-check.yaml
    with:
      TESTS_DIRECTORY: tests
      XRAY_PATH: xray-warp-test-path
      XRAY_UUID: eefc8f5f-f2fe-43b5-881c-653994d5a617
    secrets:
      XRAY_HOST: ${{ secrets.XRAY_HOST }}
    needs: [setup-staging-environment]

  destroy-staging-environment:
    if: ${{ !cancelled() }}
    runs-on: ubuntu-latest
    env:
      TF_API_TOKEN: ${{ secrets.TF_API_TOKEN }}
    steps:
      - name: destroy-staging-environment
        uses: ./.github/workflows/destroy-environment-staging.yaml
        with:
          CONFIG_DIRECTORY: tests/infrastructure
      - name: Force fail after failed xray connectivity check
        run: |
          if [[ "${needs.check-xray-warp-ct-server-connectivity.result}" == "failure" ]]; then
              echo "‚ùå Xray connectivity job was not successful."
              exit 1
          else
              exit 0
          fi
    needs: [xray-warp-ct-connecivity-check]
