name: obtain-tls-certificate
#on:
#  schedule:
#    - cron: "0 22 * * 4"

on: workflow_dispatch

env:
  CLOUDFLARE_DNS_API_TOKEN: ${{ secrets.CLOUDFLARE_TOKEN }}
  DOMAIN_NAME: ${{ secrets.DOMAIN_NAME }}
  ACME_ACCOUNT: ${{ secrets.ACME_ACCOUNT }}

jobs:
  obtain-tls-certificate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: "Create tls certificate"
        run: ./helpers_scripts/obtain-cert.sh
      - name: Copy TLS cert and key to workspace
        run: |
          mkdir -p $GITHUB_WORKSPACE/certs
          sudo cp /var/snap/lego/common/.lego/certificates/$DOMAIN_NAME.crt $GITHUB_WORKSPACE/certs/ 
          sudo cp /var/snap/lego/common/.lego/certificates/$DOMAIN_NAME.key $GITHUB_WORKSPACE/certs/
          sudo chown $USER:$USER $GITHUB_WORKSPACE/certs/*
      - name: upload tls cert and key
        uses: actions/upload-artifact@v4
        with:
          name: tls-cert-and-key-artifact
          path: |
            $GITHUB_WORKSPACE/certs/*
