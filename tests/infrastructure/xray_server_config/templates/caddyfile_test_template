{
	acme_dns cloudflare {env.CLOUDFLARE_AUTH_TOKEN}
	default_bind 0.0.0.0
	https_port 443
}

(security_header) {
	header {
		-Server
	}
}

${DOMAIN_NAME} {
	tls {
		tls internal
		protocols tls1.3 tls1.3
		ciphers TLS_AES_256_GCM_SHA384 TLS_CHACHA20_POLY1305_SHA256
		curves x25519
	}

	@xray_xhttp {
		path /${XRAY_PATH}/*
	}

	handle @xray_xhttp {
		reverse_proxy @xray_xhttp 0.0.0.0:8443 {
			header_up X-Real-IP {http.request.header.CF-Connecting-IP}
			header_up X-Forwarded-For {http.request.header.CF-Connecting-IP}
			flush_interval -1
			transport http {
				versions h2c
			}
		}
	}
	handle {
		header Content-Type application/json
		respond `{"error": "Unauthorized", "message": "Invalid or Missing API Key"}` 401 {
			close
		}
	}
}
